#lang typed/racket
(require green-lisp/x86-64 green-lisp/label-interface)
(provide file)

(define strtab-shdr
  (lambda ()
    (data-list
     (label 'strtab-shdr-start)
     (data-unsigned 32 '(- strtab-string shstrtab-start)) ;; sh_name:   section name, index in string table
     (data-unsigned 32 SHT_STRTAB) ;; sh_type:   type of section
     (data-unsigned 64 0) ;; sh_flags:  section attributes
     (data-unsigned 64 0) ;; sh_addr:   section virtual address at execution
     (data-unsigned 64 '(- strtab-start start)) ;; sh_offset: section file offset
     (data-unsigned 64 '(- strtab-end strtab-start)) ;; sh_size:   size of section in bytes
     (data-unsigned 32 0) ;; sh_link:   index of another section
     (data-unsigned 32 0) ;; sh_info:   additional section information
     (data-unsigned 64 1) ;; sh_addralign: section alignment
     (data-unsigned 64 0) ;; sh_entsize:   entry size if section holds table
     (label 'strtab-shdr-end))))
  
(define symtab-shdr
  (lambda ()
    (data-list
     (label 'symtab-shdr-start)
     (data-unsigned 32 '(- symtab-string shstrtab-start)) ;; sh_name:   section name, index in string table
     (data-unsigned 32 SHT_SYMTAB) ;; sh_type:   type of section
     (data-unsigned 64 0) ;; sh_flags:  section attributes
     (data-unsigned 64 0) ;; sh_addr:   section virtual address at execution
     (data-unsigned 64 '(- symbols-start start)) ;; sh_offset: section file offset
     (data-unsigned 64 '(- symbols-end symbols-start)) ;; sh_size:   size of section in bytes
     (data-unsigned 32 3) ;; TODO FIXME calculate this sh_link:   index of another section
     (data-unsigned 32 3) ;; TODO CALCULATE WHAT DOES THIS MEAN sh_info:   additional section information "The global symbols immediately follow the local symbols in the symbol table. The first global symbol is identified by the symbol table sh_info value. Local and global symbols are always kept separate in this manner, and cannot be mixed together."
     (data-unsigned 64 8) ;; sh_addralign: section alignment
     (data-unsigned 64 24) ;; TODO THIS IS THE SIZE OF ONE SYMBOL sh_entsize:   entry size if section holds table
     (label 'symtab-shdr-end))))
